# 个人服药闹钟小程序PRD（微信小程序版）

## 1. 概述
一款专为需要长期服药的用户设计的微信小程序，提供个性化用药提醒、灵活剂量定制、用药统计分析等功能，帮助用户提高用药依从性，改善治疗效果。采用前后端分离架构，功能松耦合，支持微信登录，并首次使用提供引导功能，所有提醒功能统一管理，支持药物颜色标识和多时间维度视图。

## 2. 技术架构
### 前后端分离设计
- **前端**：微信小程序原生开发，负责用户界面展示和交互
- **后端**：RESTful API服务，负责业务逻辑处理和数据存储
- **通信方式**：HTTP/HTTPS API调用，JSON数据格式
- **身份验证**：微信登录，使用OpenID作为用户标识

### 功能模块划分
- **前端模块**：用户界面、交互逻辑、本地缓存、微信API调用
- **后端模块**：用户管理、药物管理、用药计划、统计分析、数据存储

## 3. 目标用户
- **核心用户**：需要长期服药的用户（包括甲减患者等各类慢性病患者）
- **次要用户**：患者家属/护理人员（需协助管理用药和监督）

## 4. 用户故事列表与验收标准

### US-001：微信登录与用户管理
- **优先级**：Must Have
- **需求分类**：
  - 用户需求：快速登录，无需记住密码
  - 业务需求：用户身份识别和数据隔离
  - 技术需求：微信登录集成，用户会话管理
- **描述**：作为服药用户，我希望通过微信快速登录个人服药闹钟，方便使用各项功能。
- **验收标准** (Given-When-Then)：
  - Given 用户首次使用个人服药闹钟，When 点击"微信登录"，Then 获取用户授权并创建账户
  - Given 用户已登录，When 重新进入个人服药闹钟，Then 自动登录并恢复数据
  - Given 用户退出登录，When 点击退出，Then 清除本地缓存并返回登录页
  - Given 用户切换账号，When 重新登录，Then 切换到对应账户数据

### US-002：首次使用引导功能
- **优先级**：Must Have
- **需求分类**：
  - 用户需求：快速了解应用使用方式
  - 业务需求：降低用户学习成本，提高留存率
  - 技术需求：聚光灯效果实现，步骤引导系统
- **描述**：作为首次使用个人服药闹钟的用户，我希望获得引导功能，帮助我快速了解如何使用各项功能。
- **验收标准** (Given-When-Then)：
  - Given 用户首次登录个人服药闹钟，When 进入首页，Then 显示聚光灯效果的引导界面
  - Given 用户处于引导界面，When 点击"下一步"，Then 聚光灯移动到下一个功能区域并显示说明
  - Given 用户完成所有引导步骤，When 点击"完成"，Then 保存用户已看过引导并关闭引导界面
  - Given 用户已看过引导，When 再次进入个人服药闹钟，Then 不再显示引导界面（除非用户手动重新开启）
  - Given 用户在引导过程中，When 点击"跳过"，Then 关闭引导界面并进入主界面

### US-003：统一提醒管理系统
- **优先级**：Must Have
- **需求分类**：
  - 用户需求：集中管理所有类型的提醒
  - 业务需求：简化提醒设置，提高用户体验
  - 技术需求：统一提醒引擎，微信订阅消息推送
- **描述**：作为服药用户，我希望有一个统一的提醒管理系统，可以管理用药提醒、补服提醒、库存提醒、复诊提醒和待办事项。
- **验收标准** (Given-When-Then)：
  - Given 用户进入提醒管理页面，When 查看界面，Then 显示所有类型的提醒选项（用药、补服、库存、复诊、待办）
  - Given 用户创建用药提醒，When 设置时间和频率，Then 提醒添加到统一提醒列表
  - Given 用户创建待办事项，When 输入内容并设置时间，Then 作为提醒类型之一显示在列表中
  - Given 用户查看所有提醒，When 进入提醒列表，Then 按时间顺序显示所有类型的提醒
  - Given 用户完成某个提醒，When 点击标记完成，Then 提醒状态更新并从活跃列表移除

### US-004：个性化用药提醒
- **优先级**：Must Have
- **需求分类**：
  - 用户需求：避免漏服或重复服药
  - 业务需求：提高用药依从性（目标提升25%）
  - 技术需求：微信订阅消息推送，统一提醒系统
- **描述**：作为服药用户，我希望按时收到用药提醒，以确保不漏服药物。
- **验收标准** (Given-When-Then)：
  - Given 用户设置了每日8:00空腹服药提醒，When 到达提醒时间，Then 微信订阅消息推送提醒
  - Given 用户收到提醒，When 点击"已服用"，Then 记录服药时间并更新统计
  - Given 用户错过提醒时间，When 2小时内未服药，Then 发送补服提醒
  - Given 用户查看提醒历史，When 进入提醒页面，Then 显示所有用药提醒记录和确认状态

### US-005：灵活剂量定制（小数形式）
- **优先级**：Must Have
- **需求分类**：
  - 用户需求：支持非整片用药（如1.5片）
  - 业务需求：适应医生开具的个性化处方
  - 技术需求：前端输入验证，后端数据存储，统一小数形式
- **描述**：作为服药用户，我希望能够设置每天的用药剂量，使用小数形式（如1.5片），不显示分数形式。
- **验收标准** (Given-When-Then)：
  - Given 用户添加药物，When 设置剂量为"1.5"，Then 前端验证通过并提交到后端
  - Given 用户设置剂量为"1.75"，When 保存设置，Then 后端存储为"1.75"并前端显示为"1.75"
  - Given 用户尝试设置无效剂量（如负数），When 点击保存，Then 前端显示错误提示
  - Given 用户查看用药记录，When 查看历史记录，Then 所有剂量均以小数形式显示（如"1.5"而非"1又1/2"）
  - Given 用户查看药物库存，When 查看库存页面，Then 库存数量也以小数形式显示（如"15.5片"）

### US-006：多药物管理（直观颜色标识）
- **优先级**：Must Have
- **需求分类**：
  - 用户需求：管理多种药物，通过直观颜色区分
  - 业务需求：提高药物识别效率，减少混淆
  - 技术需求：预设颜色选择器，药物颜色存储，界面渲染
- **描述**：作为服药用户，我希望能够为不同药物设置不同的颜色，通过直观的方式在界面中快速区分和识别。
- **验收标准** (Given-When-Then)：
  - Given 用户添加药物，When 点击颜色选择按钮，Then 显示预设的颜色选项（如红色、蓝色、绿色、黄色、紫色等）
  - Given 用户选择蓝色，Then 药物名称和相关信息显示为蓝色
  - Given 用户选择绿色，Then 药物名称和相关信息显示为绿色
  - Given 用户查看药物列表，When 进入药物管理页面，Then 每个药物显示其选择的颜色标识
  - Given 用户修改药物颜色，When 选择新颜色并保存，Then 界面中所有相关元素更新为新颜色
  - Given 用户查看用药计划，When 进入计划页面，Then 不同药物使用不同颜色显示，便于区分

### US-007：用药计划管理
- **优先级**：Should Have
- **需求分类**：
  - 用户需求：根据医嘱调整用药计划
  - 业务需求：支持治疗方案长期固定，必要时调整
  - 技术需求：后端计划版本控制，前端计划切换界面
- **描述**：作为服药用户，我希望能够管理不同时期的用药计划，适应治疗方案的调整。
- **验收标准** (Given-When-Then)：
  - Given 用户当前有"初始方案"，When 创建新方案"调整后方案"，Then 后端保存两个方案并前端显示选项
  - Given 用户设置"调整后方案"生效日期，When 到达该日期，Then 前端自动切换显示新方案
  - Given 用户查看历史方案，When 选择特定日期，Then 前端向后端请求并显示该日期生效的用药计划
  - Given 用户需要长期固定方案，When 设置为"长期有效"，Then 后端标记为长期方案并前端持续显示

### US-008：多时间维度用药统计视图
- **优先级**：Should Have
- **需求分类**：
  - 用户需求：从不同时间维度查看用药计划和统计
  - 业务需求：全面了解用药规律和依从性
  - 技术需求：日历组件，数据聚合，颜色渲染
- **描述**：作为服药用户，我希望能够按照天、周和月来查看用药计划和用药情况统计，并通过颜色直观显示服药状态。
- **验收标准** (Given-When-Then)：
  - Given 用户查看日视图，When 切换到日视图，Then 显示当天的用药计划和服药状态
  - Given 用户查看周视图，When 切换到周视图，Then 显示一周的日历，日期显示需要服用药物的颜色（半透明）
  - Given 用户查看月视图，When 切换到月视图，Then 显示一个月的日历，日期显示需要服用药物的颜色（半透明）
  - Given 用户在周/月视图中查看某日，When 点击某日期，Then 显示该日期的详细用药计划
  - Given 用户在周/月视图中查看已服药日期，When 查看已服药日期，Then 日期显示药物颜色（不透明）
  - Given 用户在周/月视图中查看未服药日期，When 查看未服药日期，Then 日期显示药物颜色（半透明）

### US-009：用药统计分析
- **优先级**：Should Have
- **需求分类**：
  - 用户需求：了解自己的用药规律和依从性
  - 业务需求：为医患沟通提供数据支持
  - 技术需求：后端数据分析，前端图表展示
- **描述**：作为服药用户，我希望查看我的用药统计，包括依从率、服药时间分布等。
- **验收标准** (Given-When-Then)：
  - Given 用户查看本周用药统计，When 进入统计页面，Then 前端向后端请求数据并显示本周依从率
  - Given 用户选择查看月度统计，When 切换到月度视图，Then 前端向后端请求月度数据并生成图表
  - Given 用户需要导出数据，When 点击导出PDF，Then 前端向后端请求数据并生成PDF报告
  - Given 用户查看历史数据，When 选择特定时间段，Then 前端向后端请求并显示该期间的用药趋势
  - Given 用户在统计页面切换时间维度，When 选择周/月视图，Then 显示对应时间维度的统计数据

### US-010：身体状态记录
- **优先级**：Should Have
- **需求分类**：
  - 用户需求：记录身体反应，评估治疗效果
  - 业务需求：为医生调整用药提供参考
  - 技术需求：后端症状数据库，前端记录界面
- **描述**：作为服药用户，我希望记录每天的身体状态，帮助评估治疗效果。
- **验收标准** (Given-When-Then)：
  - Given 用户记录"疲劳感"，When 保存记录，Then 前端提交到后端并关联到当天的用药记录
  - Given 用户记录"体重变化"，When 输入具体数值，Then 后端保存并前端生成趋势图
  - Given 用户连续记录30天，When 生成报告，Then 后端分析数据并前端显示症状与用药的关联
  - Given 用户有明显不适，When 记录不适症状，Then 前端提示可能需要就医

### US-011：药物库存管理（小数形式）
- **优先级**：Should Have
- **需求分类**：
  - 用户需求：避免药物短缺
  - 业务需求：确保持续治疗
  - 技术需求：后端库存计算，前端库存展示，统一小数形式
- **描述**：作为服药用户，我希望管理药物库存，及时补充药品，库存数量以小数形式显示。
- **验收标准** (Given-When-Then)：
  - Given 用户添加药物库存，When 输入数量和购买日期，Then 后端计算剩余天数并前端显示
  - Given 用户查看库存，When 进入库存页面，Then 前端向后端请求并显示剩余药量和预计使用天数
  - Given 用户库存低于7天，When 后端检测，Then 前端显示补充提醒并添加到统一提醒系统
  - Given 用户记录用药，When 消耗药物，Then 前端提交到后端更新库存数量（保持小数形式）
  - Given 用户查看库存详情，When 点击具体药物，Then 显示库存变化历史，所有数量均以小数形式显示

### US-012：待办事项管理
- **优先级**：Could Have
- **需求分类**：
  - 用户需求：记录和管理各种待办事项
  - 业务需求：扩展提醒系统的应用场景
  - 技术需求：统一提醒系统扩展，待办事项CRUD
- **描述**：作为服药用户，我希望能够添加和管理各种待办事项，如体检预约、饮食调整等，这些事项也可以作为提醒。
- **验收标准** (Given-When-Then)：
  - Given 用户添加待办事项，When 输入内容和时间，Then 添加到统一提醒系统并显示在提醒列表中
  - Given 用户查看待办事项，When 进入待办页面，Then 显示所有待办事项并可按状态筛选
  - Given 用户完成待办事项，When 点击标记完成，Then 更新状态并从活跃列表移除
  - Given 用户设置待办提醒，When 设置提醒时间，Then 作为统一提醒的一部分进行推送
  - Given 用户编辑待办事项，When 修改内容或时间，Then 更新到统一提醒系统中

## 5. 前后端功能划分

### 前端功能（微信小程序）
- **用户界面**：页面布局、组件展示、样式设计
- **交互逻辑**：用户操作处理、表单验证、状态管理
- **本地缓存**：微信Storage API、离线数据存储
- **微信API调用**：登录、订阅消息、分享等
- **数据展示**：图表渲染、列表展示、详情页面
- **用户输入**：表单输入、选择器、日期选择等
- **引导功能**：聚光灯效果实现、步骤引导系统
- **日历组件**：天/周/月视图切换，服药状态颜色渲染
- **直观颜色选择器**：预设颜色选项，避免用户输入十六进制代码

### 后端功能（RESTful API）
- **用户管理**：用户注册、登录、信息管理
- **药物管理**：药物CRUD、药物颜色管理、药物数据库维护
- **用药计划**：计划创建、修改、版本控制
- **统计分析**：数据计算、趋势分析、报告生成
- **统一提醒系统**：提醒创建、管理、推送服务
- **数据存储**：MySQL/PostgreSQL数据库、Redis缓存
- **权限控制**：用户权限、数据隔离、安全验证

## 6. 药物直观颜色标识系统

### 颜色选择功能设计
- **预设颜色选项**：提供6-8种直观的颜色选项（如红色、蓝色、绿色、黄色、紫色、橙色、粉色、青色）
- **颜色名称显示**：每个颜色选项旁边显示颜色名称，便于用户理解
- **颜色预览**：点击颜色选项时，实时预览该颜色在界面中的效果
- **默认颜色**：为每种新药物随机分配一个预设颜色，避免用户需要手动选择

### 颜色选择界面
```
[红色]  [蓝色]  [绿色]  [黄色]
[紫色]  [橙色]  [粉色]  [青色]
```

### 颜色数据结构
```json
{
  "medicationId": "string",
  "name": "string",
  "dosage": 1.5,
  "color": "blue",  // 使用颜色名称而非十六进制代码
  "colorHex": "#3366FF",  // 后端存储十六进制代码，前端显示使用
  "unit": "片",
  "instructions": "string"
}
```

### 颜色应用场景
- **药物列表**：药物名称和图标使用设置的颜色
- **用药计划**：不同药物使用不同颜色区分
- **日历视图**：需要服药的日期显示对应药物的颜色
- **统计图表**：不同药物使用不同颜色表示
- **提醒通知**：提醒内容中包含药物颜色标识

## 7. 多时间维度视图设计

### 视图类型
- **日视图**：显示当天的用药计划和服药状态
- **周视图**：显示一周的日历，日期显示需要服用药物的颜色
- **月视图**：显示一个月的日历，日期显示需要服用药物的颜色

### 日历视图颜色规则
- **半透明颜色**：表示该日期需要服用药物但尚未服用
- **不透明颜色**：表示该日期已经服用药物
- **无颜色**：表示该日期不需要服用药物

### 视图切换逻辑
- 用户可以在日/周/月视图之间切换
- 切换视图时保持当前选中的日期范围
- 视图切换时重新渲染日历和统计数据

### 数据聚合逻辑
- **日视图**：显示当天所有药物的用药计划和服药状态
- **周视图**：聚合一周内每天的用药情况和服药状态
- **月视图**：聚合一个月内每天的用药情况和服药状态

## 8. 统一提醒系统设计

### 提醒类型
- **用药提醒**：定时提醒用户服药
- **补服提醒**：错过用药时间后的补服提醒
- **库存提醒**：药物库存不足时的补充提醒
- **复诊提醒**：定期复诊的提醒
- **待办事项**：用户自定义的各种待办事项

### 提醒数据结构
```json
{
  "reminderId": "string",
  "userId": "string",
  "type": "medication|reminder|stock|followup|todo",
  "title": "string",
  "content": "string",
  "scheduledTime": "datetime",
  "repeat": "none|daily|weekly|monthly",
  "status": "active|completed|dismissed",
  "relatedEntity": {
    "type": "medication|plan|stock",
    "id": "string"
  },
  "color": "blue"  // 使用颜色名称
}
```

## 9. 剂量数据统一小数形式

### 数据存储规范
- 所有剂量数据统一存储为小数形式（如1.5而非3/2）
- 前端显示也统一使用小数形式
- 计算和统计基于小数形式进行
- 确保数据逻辑的一致性

### 示例数据
```json
// 用药记录
{
  "userId": "openid",
  "medicationId": "123",
  "dosage": 1.5,  // 统一小数形式
  "time": "2024-01-01T08:00:00Z",
  "status": "taken"
}

// 药物库存
{
  "userId": "openid",
  "medicationId": "123",
  "quantity": 15.5,  // 统一小数形式
  "unit": "片",
  "lastUpdated": "2024-01-01T08:00:00Z"
}
```

## 10. 首次使用引导功能设计

### 引导流程
1. 欢迎页面：介绍个人服药闹钟主要功能
2. 药物添加引导：演示如何添加药物和选择颜色
3. 用药计划设置引导：演示如何设置用药计划
4. 提醒功能引导：演示如何设置提醒
5. 完成引导：提供跳过选项和重新查看入口

### 聚光灯效果实现
- 使用半透明遮罩层覆盖非引导区域
- 引导区域高亮显示并配有说明文字
- 提供上一步/下一步按钮控制引导流程
- 支持用户跳过引导

## 11. API接口设计

### 核心API端点
- `POST /api/user/login` - 微信登录
- `GET /api/user/profile` - 获取用户信息
- `POST /api/medication/add` - 添加药物
- `GET /api/medication/list` - 获取药物列表
- `PUT /api/medication/{id}/color` - 更新药物颜色
- `POST /api/plan/create` - 创建用药计划
- `GET /api/plan/current` - 获取当前用药计划
- `POST /api/record/medication` - 记录服药
- `GET /api/statistics/weekly` - 获取周统计
- `POST /api/export/pdf` - 导出PDF报告
- `POST /api/reminder/create` - 创建提醒
- `GET /api/reminder/list` - 获取提醒列表
- `PUT /api/reminder/{id}/complete` - 完成提醒
- `POST /api/todo/create` - 创建待办事项
- `GET /api/calendar/daily` - 获取日视图数据
- `GET /api/calendar/weekly` - 获取周视图数据
- `GET /api/calendar/monthly` - 获取月视图数据

## 12. 优先级
- **Must Have**：US-001（微信登录与用户管理）、US-002（首次使用引导功能）、US-003（统一提醒管理系统）、US-004（个性化用药提醒）、US-005（灵活剂量定制）、US-006（多药物管理）、US-008（多时间维度用药统计视图）
- **Should Have**：US-007（用药计划管理）、US-009（用药统计分析）、US-010（身体状态记录）、US-011（药物库存管理）
- **Could Have**：US-012（待办事项管理）
- **Won't Have**（本期）：社交分享功能、多设备同步、与医院HIS系统对接、老年用户友好设计

## 13. 微信小程序特性考虑

### 微信登录集成
- 使用`wx.login()`获取code，换取openid
- 结合`wx.getUserProfile()`获取用户信息
- 实现自动登录和会话保持

### 订阅消息推送
- 申请订阅消息模板
- 实现统一提醒系统的各类推送
- 支持用户自定义提醒时间和方式

### 本地缓存策略
- 使用`wx.setStorage()`存储用户偏好设置
- 离线时使用本地数据，联网后同步
- 实现数据增量同步机制

## 14. 商业价值分析
- **用户价值**：提高用药依从性，改善治疗效果，减少因漏服导致的健康风险
- **业务价值**：建立通用服药管理平台，适用于各类慢性病患者，形成健康管理生态
- **技术价值**：前后端分离架构，便于功能扩展和维护，支持快速迭代

## 15. 风险提示
- **数据安全风险**（中）：涉及个人健康数据，需确保HTTPS传输和数据加密
- **微信依赖风险**（中）：依赖微信生态，需考虑微信政策变化的影响
- **用户接受度风险**（中）：首次使用引导设计不当可能导致用户流失